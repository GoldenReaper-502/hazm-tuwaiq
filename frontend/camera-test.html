<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ - Hazm Tuwaiq</title>
  <style>
    :root {
      --bg1: #07110f;
      --bg2: #0b2d24;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent2: #20c997;
      --accent: #ff9800;
    }
    
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, "Segoe UI", Arial;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2, h3 { margin-top: 0; }
    
    .section {
      background: rgba(10, 20, 18, .72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
    }
    
    .status {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .status.success {
      background: rgba(32, 201, 151, 0.2);
      border: 1px solid var(--accent2);
      color: var(--accent2);
    }
    
    .status.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    
    .status.warning {
      background: rgba(255, 152, 0, 0.2);
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    
    .video-box {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 16px auto;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--accent2);
    }
    
    video, canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: var(--accent2);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #1ab38a;
      transform: translateY(-2px);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button.danger {
      background: #f44336;
      color: #fff;
    }
    
    button.danger:hover:not(:disabled) {
      background: #da190b;
    }
    
    .info {
      background: rgba(32, 201, 151, 0.1);
      border: 1px solid var(--accent2);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .device-list {
      list-style: none;
      padding: 0;
      margin: 16px 0;
    }
    
    .device-list li {
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid var(--accent2);
    }
    
    .device-label {
      font-weight: 600;
      color: var(--accent2);
      font-family: monospace;
      word-break: break-all;
    }
    
    pre {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
      font-size: 12px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .section { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“· Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ - Hazm Tuwaiq</h1>
    
    <!-- Browser Support Section -->
    <div class="section">
      <h2>1ï¸âƒ£ Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­</h2>
      <div id="browserStatus" class="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
      <pre id="browserInfo"></pre>
    </div>
    
    <!-- Permissions Section -->
    <div class="section">
      <h2>2ï¸âƒ£ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
      <div class="controls">
        <button onclick="checkPermissions()">ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
      </div>
      <pre id="permissionsInfo"></pre>
    </div>
    
    <!-- Devices Section -->
    <div class="section">
      <h2>3ï¸âƒ£ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h2>
      <div class="controls">
        <button onclick="discoverDevices()">Ø§ÙƒØªØ´Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</button>
      </div>
      <ul id="devicesList" class="device-list"></ul>
    </div>
    
    <!-- Camera Test Section -->
    <div class="section">
      <h2>4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h2>
      
      <div class="controls">
        <select id="cameraSelect">
          <option value="">Ø§Ø®ØªØ± ÙƒØ§Ù…ÙŠØ±Ø§...</option>
        </select>
        <button onclick="startCamera()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button onclick="stopCamera()" class="danger" disabled>Ø£ÙˆÙ‚Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button onclick="captureFrame()">Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©</button>
      </div>
      
      <div class="video-box" id="videoBox" style="display:none;">
        <video id="testVideo" autoplay playsinline muted></video>
        <canvas id="testCanvas"></canvas>
      </div>
      
      <div id="cameraStatus" class="status warning">Ù…ØªÙˆÙ‚ÙØ©</div>
      <div id="cameraError" style="display:none;" class="info" style="border-color: #f44336; background: rgba(244, 67, 54, 0.1);">
        <strong>Ø®Ø·Ø£:</strong> <span id="errorMsg"></span>
      </div>
      
      <div class="grid">
        <div>
          <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h3>
          <pre id="cameraInfo">Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</pre>
        </div>
        <div>
          <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø±</h3>
          <pre id="frameInfo">Ù„Ù… ØªÙ„ØªÙ‚Ø· Ø¥Ø·Ø§Ø± Ø¨Ø¹Ø¯</pre>
        </div>
      </div>
    </div>
    
    <!-- Troubleshooting Section -->
    <div class="section">
      <h2>â“ Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h2>
      <div class="info">
        <h3>Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©:</h3>
        <ul>
          <li><strong>Ø´Ø§Ø´Ø© Ø³ÙˆØ¯Ø§Ø¡:</strong> ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø±. Ø£ØºÙ„Ù‚Ù‡Ø§ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</li>
          <li><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø±ÙÙˆØ¶Ø©:</strong> ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­.</li>
          <li><strong>HTTPS Ù…Ø·Ù„ÙˆØ¨:</strong> Ø§Ø³ØªØ®Ø¯Ù… <code>localhost</code> Ø£Ùˆ <code>https</code> ÙÙ‚Ø·.</li>
          <li><strong>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§:</strong> ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØµÙŠÙ„ Ø¬Ù‡Ø§Ø² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</li>
          <li><strong>NotReadableError:</strong> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù…Ù† Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø±.</li>
        </ul>
      </div>
    </div>
  </div>
  
  <script>
    function log(msg) {
      console.log("[Camera Test]", msg);
    }
    
    // Check Browser Support
    window.addEventListener('DOMContentLoaded', async () => {
      const browserStatus = document.getElementById('browserStatus');
      const browserInfo = document.getElementById('browserInfo');
      
      const hasWebRTC = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      const hasPermissions = !!navigator.permissions;
      const isSecureContext = window.isSecureContext;
      
      const info = {
        "Browser": navigator.userAgent.split(') ')[0] + ')',
        "Web RTC Support": hasWebRTC ? "âœ“" : "âœ—",
        "Permissions API": hasPermissions ? "âœ“" : "âœ—",
        "Secure Context": isSecureContext ? "âœ“" : "âœ—",
        "Protocol": window.location.protocol,
        "Hostname": window.location.hostname,
      };
      
      browserInfo.textContent = JSON.stringify(info, null, 2);
      
      if (hasWebRTC) {
        browserStatus.className = 'status success';
        browserStatus.textContent = 'âœ“ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      } else {
        browserStatus.className = 'status error';
        browserStatus.textContent = 'âœ— Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      }
      
      await discoverDevices();
    });
    
    async function checkPermissions() {
      const output = document.getElementById('permissionsInfo');
      
      try {
        const perms = await navigator.permissions.query({ name: 'camera' });
        const info = {
          "Camera Permission": perms.state,
          "Status": perms.state === 'granted' ? 'âœ“ Ù…ÙˆØ§ÙÙ‚' : (perms.state === 'prompt' ? 'âš  Ø³Ø¤Ø§Ù„' : 'âœ— Ù…Ø±ÙÙˆØ¶'),
        };
        
        // Listen for changes
        perms.addEventListener('change', () => {
          info["Last Check"] = new Date().toLocaleTimeString("ar-SA");
        });
        
        output.textContent = JSON.stringify(info, null, 2);
      } catch (e) {
        output.textContent = `Ø®Ø·Ø£: ${e.message}\n\nÙ‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Permissions API`;
      }
    }
    
    async function discoverDevices() {
      const list = document.getElementById('devicesList');
      const select = document.getElementById('cameraSelect');
      
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(d => d.kind === 'videoinput');
        
        list.innerHTML = '';
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙƒØ§Ù…ÙŠØ±Ø§...</option>';
        
        if (cameras.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø©';
          list.appendChild(li);
          return;
        }
        
        cameras.forEach((cam, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span class="device-label">#${idx + 1}</span>
            <div>Name: ${cam.label || 'Unknown'}</div>
            <div>ID: ${cam.deviceId}</div>
          `;
          list.appendChild(li);
          
          const opt = document.createElement('option');
          opt.value = cam.deviceId;
          opt.textContent = `${cam.label || `Camera ${idx + 1}`}`;
          select.appendChild(opt);
        });
        
        log(`Found ${cameras.length} camera(s)`);
      } catch (e) {
        log(`Error: ${e.message}`);
        list.innerHTML = `<li>Ø®Ø·Ø£: ${e.message}</li>`;
      }
    }
    
    let stream = null;
    let video = null;
    let canvas = null;
    let ctx = null;
    
    async function startCamera() {
      const select = document.getElementById('cameraSelect');
      const deviceId = select.value;
      const videoBox = document.getElementById('videoBox');
      const cameraStatus = document.getElementById('cameraStatus');
      const cameraError = document.getElementById('cameraError');
      
      if (!deviceId) {
        cameraError.style.display = 'block';
        document.getElementById('errorMsg').textContent = 'Ø§Ø®ØªØ± ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙˆÙ„Ø§Ù‹';
        return;
      }
      
      try {
        video = document.getElementById('testVideo');
        canvas = document.getElementById('testCanvas');
        ctx = canvas.getContext('2d');
        
        cameraStatus.textContent = 'ğŸŸ¡ ØªØ­Ø¶ÙŠØ±...';
        cameraStatus.className = 'status warning';
        cameraError.style.display = 'none';
        
        stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId } },
          audio: false,
        });
        
        video.srcObject = stream;
        
        // Wait for video to load
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            resolve();
          };
        });
        
        videoBox.style.display = 'block';
        
        const info = {
          "Resolution": `${video.videoWidth}x${video.videoHeight}px`,
          "State": "Running",
          "Track": stream.getVideoTracks()[0].label,
        };
        
        document.getElementById('cameraInfo').textContent = JSON.stringify(info, null, 2);
        cameraStatus.textContent = `ğŸŸ¢ ØªØ¹Ù…Ù„ - ${video.videoWidth}x${video.videoHeight}`;
        cameraStatus.className = 'status success';
        
        document.querySelector('button[onclick="startCamera()"]').disabled = true;
        document.querySelector('button[onclick="stopCamera()"]').disabled = false;
        
        log('Camera started');
      } catch (e) {
        log(`Camera error: ${e.message}`);
        cameraStatus.textContent = 'ğŸ”´ Ø®Ø·Ø£';
        cameraStatus.className = 'status error';
        cameraError.style.display = 'block';
        document.getElementById('errorMsg').textContent = e.message;
      }
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      
      const videoBox = document.getElementById('videoBox');
      const cameraStatus = document.getElementById('cameraStatus');
      
      videoBox.style.display = 'none';
      cameraStatus.textContent = 'âš« Ù…ØªÙˆÙ‚ÙØ©';
      cameraStatus.className = 'status warning';
      
      document.querySelector('button[onclick="startCamera()"]').disabled = false;
      document.querySelector('button[onclick="stopCamera()"]').disabled = true;
      
      log('Camera stopped');
    }
    
    function captureFrame() {
      if (!video || video.videoWidth === 0) {
        alert('Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      ctx.drawImage(video, 0, 0);
      
      const info = {
        "Width": canvas.width,
        "Height": canvas.height,
        "Data URL Length": canvas.toDataURL('image/jpeg').length,
        "Timestamp": new Date().toLocaleTimeString("ar-SA"),
      };
      
      document.getElementById('frameInfo').textContent = JSON.stringify(info, null, 2);
      log('Frame captured');
    }
  </script>
</body>
</html>